<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Mapping Arcadia High: Painting a voxel world | xing liu ∧ 刘行</title>
<meta name="generator" content="Jekyll v3.9.3" />
<meta property="og:title" content="Mapping Arcadia High: Painting a voxel world" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="The idea was to use the native WebGL mesh rasterizer instead of the custom distance-field-accelerated raymarching algorithm for the initial rays cast into the scene, while keeping the raymarching for the secondary bounces. At first, this was done with plain mesh rasterization into 1x1 quads, but even with overlap and normals culling, mesh rasterization performs approximately 2x worse than SDF raymarching. So I had to simplify the mesh. By using a greedy voxel meshing algorithm popularized by Mikola Lysenko, I was able to significantly reduce the number of polygons, and the performance shifted in the mesh rasterizer’s favor. Without reflections, the mesh rasterizer with a simplified mesh performs approximately 1.5x to 2x better than SDF raymarching." />
<meta property="og:description" content="The idea was to use the native WebGL mesh rasterizer instead of the custom distance-field-accelerated raymarching algorithm for the initial rays cast into the scene, while keeping the raymarching for the secondary bounces. At first, this was done with plain mesh rasterization into 1x1 quads, but even with overlap and normals culling, mesh rasterization performs approximately 2x worse than SDF raymarching. So I had to simplify the mesh. By using a greedy voxel meshing algorithm popularized by Mikola Lysenko, I was able to significantly reduce the number of polygons, and the performance shifted in the mesh rasterizer’s favor. Without reflections, the mesh rasterizer with a simplified mesh performs approximately 1.5x to 2x better than SDF raymarching." />
<link rel="canonical" href="http://localhost:4000/blog/art/code/2022/07/27/map.html" />
<meta property="og:url" content="http://localhost:4000/blog/art/code/2022/07/27/map.html" />
<meta property="og:site_name" content="xing liu ∧ 刘行" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-07-27T00:00:00-07:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Mapping Arcadia High: Painting a voxel world" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-07-27T00:00:00-07:00","datePublished":"2022-07-27T00:00:00-07:00","description":"The idea was to use the native WebGL mesh rasterizer instead of the custom distance-field-accelerated raymarching algorithm for the initial rays cast into the scene, while keeping the raymarching for the secondary bounces. At first, this was done with plain mesh rasterization into 1x1 quads, but even with overlap and normals culling, mesh rasterization performs approximately 2x worse than SDF raymarching. So I had to simplify the mesh. By using a greedy voxel meshing algorithm popularized by Mikola Lysenko, I was able to significantly reduce the number of polygons, and the performance shifted in the mesh rasterizer’s favor. Without reflections, the mesh rasterizer with a simplified mesh performs approximately 1.5x to 2x better than SDF raymarching.","headline":"Mapping Arcadia High: Painting a voxel world","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/blog/art/code/2022/07/27/map.html"},"url":"http://localhost:4000/blog/art/code/2022/07/27/map.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="xing liu ∧ 刘行" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">xing liu ∧ 刘行</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">about</a><a class="page-link" href="/friends/">friends!</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Mapping Arcadia High: Painting a voxel world</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2022-07-27T00:00:00-07:00" itemprop="datePublished">Jul 27, 2022
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>The idea was to use the native WebGL mesh rasterizer instead of the custom distance-field-accelerated raymarching algorithm for the initial rays cast into the scene, while keeping the raymarching for the secondary bounces. At first, this was done with plain mesh rasterization into 1x1 quads, but even with overlap and normals culling, mesh rasterization performs approximately 2x worse than SDF raymarching. So I had to simplify the mesh. By using <a href="https://gist.github.com/Vercidium/a3002bd083cce2bc854c9ff8f0118d33">a greedy voxel meshing algorithm</a> popularized by <a href="https://0fps.net/2012/06/30/meshing-in-a-minecraft-game/">Mikola Lysenko</a>, I was able to significantly reduce the number of polygons, and the performance shifted in the mesh rasterizer’s favor. Without reflections, the mesh rasterizer with a simplified mesh performs approximately 1.5x to 2x better than SDF raymarching.</p>

<p>However, the now comparatively slow raymarching was still used to calculate whether the first point is in the shadow, where a ray is reflected to, and whether the reflected point is in shadow. I was able to eliminate the need to raymarch the shadow of the reflected point by utilizing screen-space reflections. This meant creating a framebuffer in addition to the default canvas, where I rendered the base color (+ raymarched shadow), and coordinates (UV) of the reflected point (via raymarching). Then, in the default canvas (now given the role of compositing), the base color of every surface is mixed with the base color at the UV of the ray reflected from the surface.</p>

<p>With reflections, this branch performed approximately 2x better than the purely-raymarched branch. Additional changes included the accounting of the reference (aka CSS) pixel to device pixel ratio for a more accurate resolution, increasing the Z range to 32 blocks (32 yards or 96 feet) to fit tall structures such as the Performing Arts Center and the pool, and speeding up the SDF texture generation with thread-based parallelization (thanks Shin) and restricting the search gradient to ±1 (distance to the nearest surface cannot change by more than the change in an observer’s position). One regression which I plan on soon fixing is the removal of glass transparency, which is not supported by depth-tested mesh rasterization.</p>

<p>Performance metrics at default position:</p>
<ul>
  <li>Reflections on:
    <ul>
      <li>Halfscreen:
        <ul>
          <li>Motorola G: 15.9 fps → 36.0 fps</li>
          <li>HP laptop: 24.6 fps → 39.9 fps</li>
        </ul>
      </li>
      <li>Fullscreen:
        <ul>
          <li>Motorola G: 5.6 fps → 15.6 fps</li>
          <li>HP laptop: 15.0 fps → 25.1 fps</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Reflections off:
    <ul>
      <li>Halfscreen:
        <ul>
          <li>Motorola G: 41.6 fps → 54.6 fps</li>
          <li>HP laptop: 20.0 fps → 39.9 fps</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

  </div><a class="u-url" href="/blog/art/code/2022/07/27/map.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">xing liu ∧ 刘行</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">xing liu ∧ 刘行</li><li><a class="u-email" href="mailto:xing@xingyzt.net">xing@xingyzt.net</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/flyorboom"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">flyorboom</span></a></li><li><a href="https://instagram.com/xingyzt"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#instagram"></use></svg> <span class="username">xingyzt</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>local thoughtspace of a possible boltzmann brain in awe of the cosmic infinite</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
