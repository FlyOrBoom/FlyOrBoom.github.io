<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Polarizar: Visual odometry for the 2023 FTC robotics competition</title>
    <meta name=viewport content='width=device-width, initial-scale=1'>
    <link rel="shortcut icon" type=image/png href="https://x-ing.space/favicon.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" integrity="sha384-GvrOXuhMATgEsSwCs4smul74iXGOixntILdUW9XmUC6+HX0sLNAK3q71HotJqlAn" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js" integrity="sha384-cpW21h6RZv/phavutF+AuVYrr+dA8xD9zs6FwLpaCct6O9ctzYFfFr4dgmgccOTx" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            renderMathInElement(document.body, {
              delimiters: [
                  //{left: '$$', right: '$$', display: true},
                  {left: '$', right: '$', display: false},
                  //{left: '\\(', right: '\\)', display: false},
                  {left: '\\[', right: '\\]', display: true}
              ],
              throwOnError : false
            });
        });
    </script>
    <style>

:root {
  --text: #416;
  --text-accent: #000;
  --link: #146;
  --link-accent: #012;
  --deco: #84e;
  --bg: #ecf;
  --bg-accent: #daf;
}

@media (prefers-color-scheme: dark) {
  :root {
    --text: #ecf;
    --text-accent: #fff;
    --link: #adf;
    --link-accent: #cef;
    --deco: #84e;
    --bg: #416;
    --bg-accent: #417;
  }
}

@media print {
  :root {
    --text: #000;
    --link: #000;
    --deco: #000;
    --bg: #fff;
  }
  details {
    display: none;
  }
}


@font-face {
    font-family: 'cmu';
    src: url('/fonts/cmunrm.woff') format('woff');
    font-weight: normal;
    font-style: normal;
}

@font-face {
    font-family: 'cmu';
    src: url('/fonts/cmunti.woff') format('woff');
    font-weight: normal;
    font-style: italic;
}


@font-face {
    font-family: 'cmu';
    src: url('/fonts/cmunbx.woff') format('woff');
    font-weight: bold;
    font-style: normal;
}


@font-face {
    font-family: 'cmu';
    src: url('/fonts/cmunbi.woff') format('woff');
    font-weight: bold;
    font-style: italic;
}

html {
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
  background-image: url("/tile.png");
}
html, body {
  font-size: 16px;
  font-family: cmu, serif;
  background-color: var(--bg);
}
html * {
  box-sizing: border-box;
}
body {
  margin: 0 auto;
  width: 50rem;
  height: auto;
  padding: 1rem;
  max-width: 100%;
  color: var(--text);
}

h1 {
  text-align: center;
}
h2 {
  border-bottom: 1px solid var(--deco);
}
h3 {
  scroll-margin: 3rem;
}
::selection {
  background: var(--text);
  color: var(--bg);
}
strong {
  font-weight: normal;
  text-decoration: dotted underline var(--deco);
}

a, summary {
  text-decoration: none;
  color: var(--link);
}

a:hover, a:focus, summary:hover, summary:focus {
  text-decoration: underline;
  color: var(--link-accent);
}
a:active, summary:active {
  background: var(--link);
  color: var(--bg-accent);
}

ul, ol {
  margin-left: 0rem;
  padding-left: 1rem;
}

table {
  border: 1px solid var(--deco);
  border-collapse: collapse;
}
th, td {
  border: 1px dashed var(--deco);
  text-align: center;
}

img, video, iframe {
  width: 30rem;
  max-width: 100%;
}
    
    </style>
  </head>
  <body><header class="site-header">
  <style>
.site-header .site-nav{
    display: flex;
    gap: 1em;
  } 
.site-header .site-title {
    flex-grow: 1;
  }
  </style>

  <nav class="site-nav"><a class="site-title" rel="author" href="/">{ xing liu ∘ 刘行 }</a><a class="page-link" href="/bog/">bog</a></nav>

  <p>in awe of the cosmic infinite</p>
</header>
<main>
      <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Polarizar: Visual odometry for the 2023 FTC robotics competition</h1>
    <p class="post-meta">
      <em><time class="dt-published" datetime="2023-02-12T00:00:00-08:00" itemprop="datePublished">Feb 12, 2023
      </time></em></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p><strong>The problem: Our robot needs to precisely navigate a field of poles.</strong></p>

<video controls="" width="720">
  <source src="/media/polarizar-w720.mp4" type="video/mp4" />
</video>

<p>Odometry is a critical component of any fast and precise Autonomous program. In designing our Autonomous strategy, we considered several conventional means of odometry, but discarded every single one for their flaws: Inertial Measurement Units suffer from significant drift during integration; Encoder odometry can be very precise on the short scales, but lack the accuracy for navigating around multiple poles; And while distance sensors can detect poles to high precision, they lack a wide field of view.</p>

<p>In the end, we decided to explore visual odometry instead, which allows our robot to know its position and orientation on the field from the camera alone. This approach is especially useful for this FTC season due to the lattice of highly visible poles on the field. The plan was this: track the positions of poles in the camera, convert them into coordinates on the field, and from them, compute the motion of the robot. In between poles, encoders can then provide more precise positions on top of visual odometry.</p>

<p>Because our specific pole recognition odometry strategy was, as far as we know, completely novel, we embarked on this project with low-level OpenCV. We first prototyped programs in Python on laptop, which was faster to debug and iterate. Our first experiment was determining the positions of cones on a table from a laptop camera: He learned to project the table onto a plane, then isolate the colors to find the centers of red and blue contours, producing accurate positions for the cones. We then applied the technique to the field: Isolating the yellow poles and projecting their lowest points onto a square plane.</p>

<p>We first planned to calculate the robot’s motion from the relative frame-by-frame changes in each pole’s position. However, this approach faced IMU-like integration drift over time: if the robot moved in a circle, its calculated position would not end up where it started. After a divine revelation from semi-nude men, we realized we could measure the poles’ absolute position from “ground-truth” measurements instead: This was not easy, because only two to three poles are visible in our off-the-shelf webcam, so there is little data to match them with the 18 ground-truth poles. However, past position estimates can crudely align them closely enough to match and calculate the absolute difference.</p>

<p>Here is the algorithm in its entirety: First, we identify the poles by color. Then, we project them onto a field-sized square plane. Next, we shift them by the last estimated robot position to match them with the absolute positions of the ground-truth poles. Finally, we calculate the difference to update the estimated robot position. Because this approach always measures against the ground truth, errors do not accumulate over time. There is noise from camera shakes and uncertain pole identification, but as long as two or more poles stay in the field of view at all times, we can obtain an accurate position of the robot from the camera alone, and the average error stays constant.</p>

<p>This can be further improved with sensor fusion: using IMUs and encoders on top of our undrifting visual odometry increases precision between poles, and distance sensors help with exact alignment directly in front of poles.</p>

  </div><a class="u-url" href="/blog/code/robotics/2023/02/12/polarizar.html" hidden></a>
</article>

    </main><footer class="site-footer">
  <style>
.site-footer .site-end {
  display: flex;
}
.site-footer .site-title {
  flex-grow: 1;
  text-align: center;
}
  </style>
  <div class="site-end">
    <span> fin. </span>
    <a class="site-title" rel="author" href="/"> { xing liu ∘ 刘行 } </a>
    <span> □ </span>
  </div><ul class="social-media-list">
  <style>
.social-media-list {
  display: flex;
  list-style: none;
  gap: 1em;
  justify-content: space-between;
}
  </style><li><a href="https://github.com/flyorboom">
      gh @flyorboom
  </a></li><li> <a href="https://instagram.com/xingyzt">
      ig @xingyzt
  </a></li></ul>
</footer>
</body>
</html>

